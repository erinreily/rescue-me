<!DOCTYPE html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Hello world!</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrVbL6gcTITP7_sqp7GGUDD4UVppmdPxA"></script>
    <script src="gmaps.js"></script>
    <script>
        function postJSON(url, data, callback) {
          return $.ajax({
                        'type': 'POST',
                        'url': url,
                        'contentType': 'application/json',
                        'data': JSON.stringify(data),
                        'dataType': 'json',
                        'success': callback,
                        'error': function(xhr, status, text) {callback(xhr.responseJSON, status, xhr);}
          });
        }
        function openDetails(id) {
            $.get("/api/requests/" + id, "", function (data, status, jqxhr) {
                if (data.status !== 'success') {
                    alert('there was an error submitting the request: ' + data.errors);
                    return;
                }
                $("#people").html("<h4>People</h4>");
                $("#pets").html("<h4>Pets</h4>");
                $('#address').html("<h4>Location</h4>");
                $('#address').append("Latitude: " + data.data.location.latitude + ', longitude: ' + data.data.location.longitude + '<br />');
                const addressSpan = $(document.createElement('span'));
                addressSpan.text('Decoding address...');
                $('#address').append(addressSpan);
                for (var i = 0; i < data.data.people.length; i++) {
                    person = data.data.people[i];
                    $('#people').append(person.name + ', ' + person.gender + ', ' + person.age + (person.comments ? ', ' + person.comments : '') + '<br />');
                }
                for (var i = 0; i < data.data.pets.length; i++) {
                    pet = data.data.pets[i];
                    $('#pets').append(pet.type + ', ' + pet.breed + ', ' + pet.age + '<br />');
                }
<<<<<<< HEAD
                // make a new button each time
                var button = $('<input class="btn btn-success btn-lg btn-block" type="submit" value="Take Job">');
                $('#takeButton').html('');
                $('#takeButton').append(button);
                button.click(function() {
                  if (button.prop('disabled'))
                    return;
                  button.prop('disabled', true);
                  postJSON("/api/requests/" + id + "/take", {}, function(respData) {
                    if (respData.status === 'success') {
                      button.replaceWith(document.createTextNode("Taken!"));
                      $('#modalConfirm').modal('hide');
                    } else {
                      alert('error taking: ' + respData.errors);
                      button.prop('disabled', false);
                    }
                  });
                });
                $('#modalConfirm').modal();
                $.get("/api/geodecode", {"latitude": data.data.location.latitude, "longitude": data.data.location.longitude}, function (geodata) {
                  if (geodata.status !== 'success') {
                    addressSpan.text('Error decoding address: ' + geodata.errors);
                    return;
                  } else {
                    addressSpan.text(geodata.data.address);
                  }
                }, 'json');
=======
                if (data.data.taken !== null) {
                  // make a new button each time
                  var button = $('<input class="btn btn-success btn-lg btn-block" type="submit" value="Take Job">');
                  $('#takeButton').html('');
                  $('#takeButton').append(button);
                  button.click(function() {
                    if (button.prop('disabled'))
                      return;
                    button.prop('disabled', true);
                    postJSON("/api/requests/" + id + "/take", {}, function(respData) {
                      if (respData.status === 'success') {
                        button.replaceWith(document.createTextNode("Taken!"));
                        $('#modalConfirm').modal('hide');
                      } else {
                        alert('error taking: ' + respData.errors);
                        button.prop('disabled', false);
                      }
                    });
                  });
                  $('#modalConfirm').modal();
                  $.get("/api/geodecode", {"latitude": data.data.location.latitude, "longitude": data.data.location.longitude}, function (geodata) {
                    if (geodata.status !== 'success') {
                      addressSpan.text('Error decoding address: ' + geodata.errors);
                      return;
                    } else {
                      addressSpan.text(geodata.data.address);
                    }
                  }, 'json');
                } else {
                  $('#takeButton').text('Already taken!');
                }
>>>>>>> 838bcce364e8bc6b6fd0a0a81fc0ab14daa4c4d3
            });
        }
        function getData() {
            var lat = 29.721826;
            var lng = -95.340518;
            var radius = 80450; //about 50 miles
            //if (navigator.geolocation) {
            //    navigator.geolocation.getCurrentPosition(function (position) {
            //        lat = position.coords.latitude;
            //        lng = position.coords.longitude;
            //    });

            $.get("/api/requests?near=" + lng + "," + lat + "&radius=" + radius, "", function (data, status, jqxhr) {
                for (var i = 0; i < data.data.length; i++) {
                    $("#panels").append('<div onclick="openDetails(' + data.data[i].id + ')" class="panel panel-default"><div class="panel-body">Severity: ' + data.data[i].severity + ' Distance: ' + data.data[i].distance + ' ID: ' + data.data[i].id + '</div></div>')
                    mapObj.addMarker({
                        lat: data.data[i].latitude,
                        lng: data.data[i].longitude,
                        title: data.data[i].id,
                        click: function (e) {
                  
                        }
                    });
                }
            });
        }
        window.onload = getData;
    </script>
</head>
<body style="background-image:url('images/rescueboat.jpg'); background-size:200%;">
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html"><span class="glyphicon glyphicon-home" aria-hidden="true"></span></a>
                <h3 class="text-center">RescueMe</h3>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="center-block" id="map" style="width:80vw;height:80vw;border:2px solid white; padding:1%;"></div>
    </div>
    <script>
        var mapObj = new GMaps({
            el: '#map',
            lat: 29.721826,
            lng: -95.340518
        });
    </script>
    <br />
    <div id="requests" class="container-fluid">
        <p style="font-size:5vw;color:white;">
            Order by
            <select name="Order" style="font-size:5vw; color:#4b4b4b; height:15vw; width:30vw">
                <option value="closeness" style="font-size:4vw;" selected><h3>Closeness</h3></option>
                <option value="severity" style="font-size:4vw;"><h3>Severity</h3></option>
            </select>
        </p>
        <br>
        <div id="panels"class="container-fluid"></div>
        <!--This html will be generated dynamically from database-->

    </div>
    <div class="modal fade" id="modalConfirm" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detailed View</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div id="modalText" class="modal-body">
                    <div id="address"></div>
                    <div id="people"></div>
                    <div id="pets"></div>
                </div>
                <div class="modal-footer">
                  <span id="takeButton"></span>
                </div>
            </div>
        </div>
    </div>
</body>
